#+auto_tangle: t

* Nix Flake entry point

#+begin_src nix :tangle flake.nix
{
  description = "My nix flake";

  ## Inputs:

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";
    nixpkgs-stable.url = "github:nixos/nixpkgs/nixos-25.05";

    # Declarative user environment.
    home-manager.url = "github:nix-community/home-manager";
    home-manager.inputs.nixpkgs.follows = "nixpkgs";

    # Music DAW with custom tarball.
    renoise-source.url = "file:/home/sui/opt/rns/rns_353_linux_x86_64.tar.gz";
    renoise-source.flake = false;

    # Real-time audio in NixOS.
    musnix.url = "github:musnix/musnix";

    # Run unpatched dynamic binaries
    nix-ld.url = "github:Mic92/nix-ld";
    nix-ld.inputs.nixpkgs.follows = "nixpkgs";

    # LSP server to visualize ownership and lifetimes in Rust.
    rustowl-flake.url = "github:nix-community/rustowl-flake";
  };

  ## Outputs:

  outputs = inputs@{ ... }:
    let
      laptop = import ./laptop.nix { };
      homelab = import ./homelab.nix { };
    in {
      nixosConfigurations = {
        laptop = laptop.laptop-config-gen { inherit inputs; };
        homelab = homelab.homelab-config-gen { inherit inputs; };
      };
    };
}
#+end_src

* Laptop

#+begin_src nix :tangle laptop.nix
{ ... }:

{
  laptop-config-gen = { inputs }:
    let
      user = "sui";
      system = "x86_64-linux";
      pkgs = import inputs.nixpkgs {
        inherit system;
        config.allowUnfreePredicate = pkg:
          builtins.elem (inputs.nixpkgs.lib.getName pkg) [
            # music
            "vital" "spotify" "renoise" "reaper" "vcv-rack"
            # games
            "steam" "steam-original" "steam-unwrapped" "steam-run"
            "osu-lazer-bin"
          ];
      };
    in inputs.nixpkgs.lib.nixosSystem {
      inherit system pkgs;
      # provide args for all modules
      specialArgs = {
        inherit inputs user system;
        pkgs-stable = import inputs.nixpkgs-stable { inherit system; };
      };
      # load modules
      modules = [
        # configure nix
        { nix.settings =
            { keep-failed = true;
              experimental-features = [ "nix-command" "flakes" ];
              download-buffer-size = 524288000;
            }; }

        # main nixos config
        ./nixos.nix

        # nix home config
        ./home.nix

        # setup nix-ld
        inputs.nix-ld.nixosModules.nix-ld
        { programs.nix-ld.dev.enable = true; }
      ];
    };
}
#+end_src

** NixOS

*** Main

#+begin_src nix :tangle laptop/nixos.nix
{ ... }:

{
  system.stateVersion = "24.05"; # don't touch

  imports = [
    ./hardware/system76
    ./packages.nix
    ./modules
  ];
}
#+end_src

*** Hardware

*** Packages

*** General

**** Desktop

**** Sound

**** System

**** User

** Home Manager

*** Main

#+begin_src nix :tangle laptop/home.nix
{ inputs, user, ... }:

{
  imports = [
    inputs.home-manager.nixosModules.home-manager
  ];

  home-manager = {
    useGlobalPkgs = true;  # use system pkgs
    useUserPackages = true;
    extraSpecialArgs = { inherit inputs user; };
    users.${user} = { ... }: {
      home = {
        username = "sui";
        homeDirectory = "/home/sui";
        stateVersion = "24.05"; # Configuration version
      };
      imports = [
        ./modules/default.nix
        ./dotfiles
        ./packages.nix
      ];
    };
  };
}
#+end_src

*** Packages

*** General

**** cron

**** git

**** gpg

**** input

**** mpd

**** themes

**** tmux

**** Zsh
